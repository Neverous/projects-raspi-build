# Raspi Build

Set of simple scripts and instructions for building customized, [Arch Linux](http://archlinux.org)([ARM](http://archlinuxarm.org)) based distro for [Raspberry Pi](http://raspberrypi.org)(or any similar embedded device).

## Why?

Well, I started this "project" when there only was armv5 image from [Arch Linux ARM](http://archlinuxarm.org) and I wanted to check how much performance it would gain from enabling hardware FPU and compiling everything specifically for raspberrypi hardware like [Raspbian](http://www.raspbian.org/) did. And I also wanted to remove stuff I dont really use on that device like LDAP, nfsv4, ipv6.

## HOWTO (Step by step instructions)
1. Prepare host system
    0. Install qemu with support for desired architecture(and also other stuff I forgot to mention)

    1. You may want to edit some config files in config/ directory.
        * customize RB_* in host.conf

    2. Run . bin/activate to enable special variables etc.

    3. Install [crosstool-ng](http://crosstool-ng.org/)
        * Preferably ./configure --prefix ${RB_WORKDIR}/host

    4. Install [scratchbox2](http://maemo.gitorious.org/scratchbox2/scratchbox2)
        * Preferably ./configure --prefix ${RB_WORKDIR}/host

2. Prepare target sysroot
    1. Build sysroot with crosstool-ng (there is example config I use in config/)
        * ct-ng menuconfig - to configure
        * ct-ng build - to build

    2. Initialize scratchbox2 directory
        * sb2-init -n -d -c ${RB_QEMUBIN} ${RB_BUILDNAME} ${RB_READYDIR}/bin/${RB_TARGET_HOST}-gcc
        * Adjust config files generated by scratchbox in ~/.scratchbox2/${RB_BUILDNAME}/sb2.config.d/
            * debian.conf
                * armel -> armhf

            * gcc.config.lua
                * extra_cross_compiler_args += -L@SBOX_TARGET_ROOT@/opt/vc/lib -I@SBOX_TARGET_ROOT@/opt/vc/include -I@SBOX_TARGET_ROOT@/opt/vc/include/interface/vcos/pthreads
                * extra_cross_ld_args += :@SBOX_TARGET_ROOT@/opt/vc/lib

            * gcc.config.sh
                * SBOX_EXTRA_CROSSCOMPILER_FLAGS += -L@SBOX_TARGET_ROOT@/opt/vc/lib -I@SBOX_TARGET_ROOT@/opt/vc/include -I@SBOX_TARGET_ROOT@/opt/vc/include/interface/vcos/pthreads
        * Adjust scratchbox2 mapping in ${RB_WORKDIR}/host/share/scratchbox2/lua_scripts/pathmaps/simple/00_default.lua:
              -- -----------------------------------------------
              -- 99. Other rules.
            -               {prefix = "/usr/share/python", use_orig_path = true, readonly = true},
            -               {prefix = "/usr/share/pyshared", use_orig_path = true, readonly = true},
            -               {prefix = "/usr/lib/pymodules", use_orig_path = true, readonly = true},
            -               {prefix = "/usr/lib/pyshared", use_orig_path = true, readonly = true},
            -               {prefix = "/usr/lib/python", use_orig_path = true, readonly = true},
            -               {prefix = "/usr/lib/perl", map_to = tools},
            +               --{prefix = "/usr/share/python", use_orig_path = true, readonly = true},
            +               --{prefix = "/usr/share/pyshared", use_orig_path = true, readonly = true},
            +               --{prefix = "/usr/lib/pymodules", use_orig_path = true, readonly = true},
            +               --{prefix = "/usr/lib/pyshared", use_orig_path = true, readonly = true},
            +               --{prefix = "/usr/lib/python", use_orig_path = true, readonly = true},
            +               --{prefix = "/usr/lib/perl", map_to = tools},
            +               {prefix = "/usr/share/perl5", map_to = target_root},
            +               {prefix = "/usr/bin/jar", use_orig_path = true, readonly = true},
            +               {prefix = "/usr/share/java", use_orig_path = true, readonly = true},
            +               {prefix = "/usr/lib/jvm", use_orig_path = true, readonly = true},
            +               {prefix = "/usr/bin/python", map_to = target_root},
            +               {prefix = "/usr/bin/perl", map_to = target_root},
            +               {prefix = "/usr/bin/python2", map_to = target_root},
            +               {prefix = "/opt", map_to = target_root},

    3. Adjust sysroot created by crosstool-ng
        * change permissions in ${RB_TARGETDIR}/* to root:root 755 (recursive)
        * move ${RB_TARGETDIR}/lib to ${RB_TARGETDIR}/usr/lib and symlink(ln -s) lib to usr/lib - its default on archlinux
        * create ${RB_TARGETDIR}/var/lib/pacman/ directory

3. Build packages
    * I'm getting PKGBUILDs from ABS or ArchlinuxARM repo
    * Use rb_makepkg instead of makepkg - it has patched support for scratchbox instead of fakeroot and uses configfile from config/
    PACKAGE BUILDING ORDER:
        (TODO)
