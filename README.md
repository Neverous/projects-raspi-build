# Raspi Build

Set of simple scripts and instructions for cross-compiling customized, [Arch Linux](http://archlinux.org)([ARM](http://archlinuxarm.org)) based distro for [Raspberry Pi](http://raspberrypi.org)(or with some modifications for any similar embedded device).

## Why?

Well, I started this "project" when there only was armv5 image from [Arch Linux ARM](http://archlinuxarm.org) and I wanted to check how much performance it would gain from enabling hardware FPU and compiling everything specifically for Raspberry Pi hardware like [Raspbian](http://www.raspbian.org/) did. And I also wanted to remove stuff I dont really use on that device like LDAP, nfsv4, ipv6.

## HOWTO (Step by step instructions)
### 1. Prepare host system
* Install qemu with support for desired architecture(and probably also other stuff I forgot to mention)
* You may want to edit some config files in `config/` directory.
    * customize `RB_*` in `host.conf`
* Run `. bin/activate` to enable special variables, custom scripts etc.
* Install [crosstool-NG](http://crosstool-ng.org/) or Linaro fork [crosstool-NG](http://code.launchpad.net/~linaro-toolchain-dev/crosstool-ng/linaro)
    * Preferably `./configure --prefix ${RB_WORKDIR}/host`
* Install [scratchbox2](http://maemo.gitorious.org/scratchbox2/scratchbox2)
    * Preferably `./configure --prefix ${RB_WORKDIR}/host`

### 2. Prepare target sysroot
* Build sysroot with crosstool-NG (there is example config I use in `config/`)
    * `ct-ng menuconfig` - to configure
    * `ct-ng build` - to build
* Initialize scratchbox2 directory
    * `sb2-init -n -d -c "${RB_QEMU}" "${RB_BUILDNAME}" "${RB_READYDIR}/bin/${RB_TARGET_HOST}-gcc"` in `${RB_TARGETDIR}` directory.
    * Adjust config files generated by scratchbox in `~/.scratchbox2/${RB_BUILDNAME}/sb2.config.d/`
        * `gcc.config.lua`
            * `extra_cross_compiler_args` += `-L@SBOX_TARGET_ROOT@/opt/vc/lib -I@SBOX_TARGET_ROOT@/opt/vc/include -I@SBOX_TARGET_ROOT@/opt/vc/include/interface/vcos/pthreads`
            * `extra_cross_ld_args` += `:@SBOX_TARGET_ROOT@/opt/vc/lib`
        * `gcc.config.sh`
            * `SBOX_EXTRA_CROSS_COMPILER_ARGS` += `-L@SBOX_TARGET_ROOT@/opt/vc/lib -I@SBOX_TARGET_ROOT@/opt/vc/include -I@SBOX_TARGET_ROOT@/opt/vc/include/interface/vcos/pthreads`
    * Adjust scratchbox2 mapping in `${RB_WORKDIR}/host/share/scratchbox2/lua_scripts/pathmaps/simple/00_default.lua`:

```diff
 -- -----------------------------------------------
 -- 99. Other rules.
                {prefix = "/usr/share/python", use_orig_path = true, readonly = true},
                {prefix = "/usr/share/pyshared", use_orig_path = true, readonly = true},
                {prefix = "/usr/lib/pymodules", use_orig_path = true, readonly = true},
                {prefix = "/usr/lib/pyshared", use_orig_path = true, readonly = true},
                {prefix = "/usr/lib/python", use_orig_path = true, readonly = true},
+               -- Change upper python binings to this before compiling python
+               --{prefix = "/usr/bin/python", map_to = target_root},
+               --{prefix = "/usr/bin/python2", map_to = target_root},
                {prefix = "/usr/lib/perl", map_to = tools},
+               -- Change up to this before compiling and installing perl in sysroot
+               --{prefix = "/usr/bin/perl", map_to = target_root},
+               --{prefix = "/usr/share/perl5", map_to = target_root},
+               {prefix = "/opt", map_to = target_root},
+               -- Add bottom after compiling and installing libtool in sysroot
+               -- {prefix = "/usr/bin/libtool", map_to = target_root},
```

* Adjust sysroot created by crosstool-NG
    * move `${RB_TARGETDIR}/lib` to `${RB_TARGETDIR}/usr/lib` and symlink(`ln -s`) `lib` to `usr/lib` - its default on Arch Linux
    * copy `${RB_READYDIR}/${RB_TARGET_HOST}/lib/*` to `${RB_TARGETDIR}/usr/lib` - missing c++ libraries
    * create `${RB_TARGETDIR}/var/lib/pacman/` directory
    * change permissions in `${RB_TARGETDIR}/*` to `root:root` `755` (recursive)

### 3. Build packages
* I'm getting PKGBUILDs from [ABS](http://wiki.archlinux.org/index.php/Arch_Build_System) or [Arch Linux ARM repo](http://github.com/archlinuxarm/PKGBUILDs) or [AUR](http://aur.archlinux.org/)
* There is `rb\_autobuild` script that tries to automate part of the build **EXPERIMENTAL**
* Ones adjusted and prepared for `rb\_autobuild` are in `PKGBUILDs/` directory
* Use `rb_makepkg` instead of `makepkg` - it has patched support for scratchbox2 instead of fakeroot and uses `makepkg.conf` from `config/`

#### PACKAGE BUILDING ORDER:
* alarm/raspberrypi-firmware
* core/linux-api-headers (**force-install**)
* core/tzdata
* core/iana-etc
* core/glibc (**force-install**)
* core/attr
* core/acl
* core/libcap
* core/libffi
* core/ncurses
* core/readline
* core/bash
* core/gmp (**force-install**)
* core/mpfr
* core/libmpc
* core/isl
* core/cloog
* core/zlib
* core/binutils (**force-install**)
* core/gcc
* core/pambase
* core/libgssglue
* core/libtirpc
* core/cracklib
* core/db
* core/m4
* core/flex
* core/pam
* core/coreutils
* core/filesystem
* core/pcre
* core/xz
* core/shadow
* core/util-linux
* core/kmod
* core/expat
* core/hwids
* extra/sqlite
* core/gdbm
* **[now change perl binding in scratchbox2]**
* core/perl
* core/openssl
* core/bzip2
* **[now change python2 binding in scratchbox2]**
* extra/python2
* **[now change python binding in scratchbox2]**
* extra/python
* core/glib2
* core/pkg-config
* extra/perl-xml-parser
* extra/intltool
* core/libgpg-error
* core/libgcrypt
* core/popt
* core/libusbx
* core/libusb-compat
* core/pciutils
* core/udev-oxnas (to satisfy udev, dev-mapper, systemd dependency cycle)
* core/lvm2
* core/cryptsetup
* core/kbd
* core/tar
* core/sed
* core/libtool
* **[now add libtool binding in scratchbox2]**
* core/gawk
* extra/libsigsegv
* core/diffutils
* core/autoconf
* core/automake
* core/dbus
* core/systemd (install with udev-oxnas removal)
* core/lvm2 (because of dbus)
* core/systemd (also)
* core/dbus (because of systemd)
* alarm/uboot-mkimage
* core/linux-raspi
