# $Id: PKGBUILD 184192 2013-05-03 11:34:41Z tpowa $
# Maintainer: Tobias Powalowski <tpowa@archlinux.org>
# Contributor: John Proctor <jproctor@prium.net>
# Contributor: dibblethewrecker <dibblethewrecker.at.jiwe.org>
# Contributor: abelstr <abel@pinklf.eu>
# Contributor: Marco Lima <cipparello gmail com>

# 05-05-2013 Raspi-Build: Maciej Szeptuch (Neverous) <neverous@neverous.info>
#   - disabled ipv6
#   - disabled nfsv4, gss

pkgname=nfs-utils
pkgver=1.2.8
pkgrel=1
pkgdesc="Support programs for Network File Systems"
arch=(${RB_TARGET_ARCH})
url='http://nfs.sourceforge.net'
license=('GPL')
backup=(etc/{exports,nfsmount.conf} etc/conf.d/{nfs-common.conf,nfs-server.conf})
depends=('glibc' 'e2fsprogs' 'rpcbind' 'libtirpc>=0.2.1' 'libevent>=2.0.10' 'libgssglue' 'device-mapper')
makedepends=('pkgconfig' 'autoconf' 'automake')
source=(http://downloads.sourceforge.net/project/nfs/${pkgname}/${pkgver}/${pkgname}-${pkgver}.tar.bz2
    nfs-common.conf
    nfs-server.conf
    exports
    start-statd.patch
    nfs
    nfs-utils-1.1.4-mtab-sym.patch
    nfs-utils-1.1.4-no-exec.patch
    rpc-mountd.service
    rpc-statd.service
    nfsd.service
    var-lib-nfs-rpc_pipefs.mount
    proc-fs-nfsd.mount
    blkmapd.service
    nfs-utils.conf)
install=nfs-utils.install

prepare() {
    cd $srcdir/${pkgname}-${pkgver}
    patch -Np1 -i ../nfs-utils-1.1.4-mtab-sym.patch
    #patch -Np1 -i ../nfs-utils-1.1.4-no-exec.patch
    # arch specific patch
    patch -Np0 -i $srcdir/start-statd.patch
}

build() {
    cd $srcdir/${pkgname}-${pkgver}
    ./configure --prefix=/usr --disable-nfsv4 --disable-nfsv41 --disable-gss \
        --without-tcp-wrappers --with-statedir=/var/lib/nfs \
        --disable-ipv6 --sysconfdir=/etc --enable-libmount-mount \
        --enable-mountconfig

    make 
}

package() {
    cd $srcdir/${pkgname}-${pkgver}
    # fix make install
    mkdir -p $pkgdir/sbin
    make DESTDIR=$pkgdir install

    # support python2 (FS#25120)
    sed -i '1s/python$/python2/' "$pkgdir"/usr/sbin/{nfsiostat,mountstats}

    # Configuration
    install -D -m 644 ../exports "$pkgdir/"etc/exports
    install -D -m 644 ../nfs-common.conf "$pkgdir/"etc/conf.d/nfs-common.conf
    install -D -m 644 ../nfs-server.conf "$pkgdir/"etc/conf.d/nfs-server.conf
    install -D -m 644 ../nfs "$pkgdir/"etc/conf.d/nfs
    install -D -m 644 utils/mount/nfsmount.conf "$pkgdir/"etc/nfsmount.conf
    # systemd files
    for i in ${srcdir}/*.{service,mount}; do
        install -D -m 644 $i "$pkgdir/usr/lib/systemd/system/${i##*/}"
    done
    install -D -m 644 ../nfs-utils.conf "$pkgdir/"usr/lib/modules-load.d/nfs-utils.conf
    # directories
    mkdir "$pkgdir/"etc/exports.d
    mkdir -m 555 "$pkgdir/"var/lib/nfs/rpc_pipefs
}
md5sums=('fb48630b7c145fb9d6602a79c6eaab11'
         '2f251466add7c69f05dca37af5ee6883'
         'c3f7ca3d4a64fe9739323fccebe1884c'
         'ff585faf410a62c4333a027c50b56bae'
         'e9144277a89a620d9bc80413158a7d27'
         '5d726f058f4e05bf018dbde4f667e4ef'
         '7674106eaaa4c149bccd4f05fe3604e9'
         '4f4827dfc93008dfadd0a530ad0872b2'
         '965311784d49a7d126d512cadbe91deb'
         'beff8a426b3b14c46e3e78a2a283e2ab'
         '5d33d2e754fd37280365b287603bac90'
         '1cd65909fa0983047f3f06a3ab352401'
         '8f1b5282795895c9b8ce8430d20cdda6'
         '8ffc2ebe932d29efe17d6f3f23d5b975'
         '8ac484023d786766d287ccbe878ae4ba')
