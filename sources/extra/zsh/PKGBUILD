# $Id: PKGBUILD 173826 2012-12-24 15:21:31Z pierre $
# Maintainer: Pierre Schmitz <pierre@archlinux.de>

# 05-05-2013 Raspi-Build: Maciej Szeptuch (Neverous) <neverous@neverous.info>
#   - disabled info

pkgname=zsh
pkgver=5.0.2
pkgrel=1
pkgdesc='A very advanced and programmable command interpreter (shell) for UNIX'
arch=(${RB_TARGET_ARCH})
url='http://www.zsh.org/'
license=('custom')
depends=('pcre' 'libcap' 'gdbm')
backup=('etc/zsh/zprofile')
install=zsh.install
source=("ftp://ftp.zsh.org/pub/${pkgname}-${pkgver}.tar.bz2"
        'zprofile')
md5sums=('b8f2ad691acf58b3252225746480dcad'
         '24a9335edf77252a7b5f52e079f7aef7')

build() {
    cd "${srcdir}/${pkgname}-${pkgver}"

    # FS#16360
    sed -i 's/init.d/rc.d/g' Doc/Zsh/compsys.yo \
        Doc/zsh.texi \
        Completion/Unix/Type/_services \
        Completion/Unix/Command/_init_d

    # Set correct keymap path
    sed -i 's#/usr/share/keymaps#/usr/share/kbd/keymaps#g' Completion/Unix/Command/_loadkeys

    # Remove unneeded and conflicting completion scripts
    rm -rf Completion/{AIX,BSD,Cygwin,Darwin,Debian,Mandriva,openSUSE,Redhat,Solaris}
    rm -f  Completion/Linux/Command/_{pkgtool,rpmbuild,yast}
    rm -f  Completion/Unix/Command/_osc

    ./configure --prefix=/usr \
        --bindir=/bin \
        --enable-etcdir=/etc/zsh \
        --enable-zshenv=/etc/zsh/zshenv \
        --enable-zlogin=/etc/zsh/zlogin \
        --enable-zlogout=/etc/zsh/zlogout \
        --enable-zprofile=/etc/zsh/zprofile \
        --enable-zshrc=/etc/zsh/zshrc \
        --enable-maildir-support \
        --with-term-lib='ncursesw' \
        --enable-multibyte \
        --enable-function-subdirs \
        --enable-fndir=/usr/share/zsh/functions \
        --enable-scriptdir=/usr/share/zsh/scripts \
        --with-tcsetpgrp \
        --enable-pcre \
        --enable-cap \
        --enable-zsh-secure-free
    make all
}

check() {
    cd "${srcdir}/${pkgname}-${pkgver}"
    HOME="${srcdir}" make check
}

package() {
    cd "${srcdir}/${pkgname}-${pkgver}"
    make DESTDIR="${pkgdir}/" install
    install -D -m644 "${srcdir}/zprofile" "${pkgdir}/etc/zsh/zprofile"
    install -D -m644 LICENCE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
